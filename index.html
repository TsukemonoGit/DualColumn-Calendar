<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>A4横・2ヶ月分割カレンダー生成</title>
    <style>
      /* 基本設定 */
      :root {
        --orange-main: #e48100;
        --gray-text: #666;
        --gray-light: #999;
        --border-solid: #e0e0e0;
        --border-dotted: #ccc;
        --bg-holiday: #fff5f5;
        --sat-blue: #1976d2;
        --sun-red: #d32f2f;
      }

      body {
        margin: 0;
        padding: 0;
        font-family:
          "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans",
          Meiryo, sans-serif;
        background-color: #f0f0f0;
      }

      /* 操作パネル */
      #controls {
        padding: 20px;
        background: white;
        border-bottom: 1px solid #ccc;
        text-align: center;
      }

      #controls input {
        font-size: 1.2rem;
        padding: 5px;
        width: 80px;
      }

      #controls button {
        font-size: 1.1rem;
        padding: 6px 20px;
        cursor: pointer;
      }

      /* 印刷設定 */
      @page {
        size: A4 landscape;
        margin: 0;
      }

      @media print {
        #controls {
          display: none;
        }
        body {
          background-color: white;
        }
        .page {
          page-break-after: always;
          box-shadow: none !important;
          margin: 0 !important;
        }
      }

      /* ページ・レイアウト */
      .page {
        width: 297mm;
        height: 210mm;
        display: flex;
        background: white;
        margin: 10px auto;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      /* 余白を最小化して記入スペースを最大化 */
      .calendar-container {
        width: 148.5mm;
        height: 210mm;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        padding: 4mm; /* 10mmから縮小 */
        position: relative;
      }

      /* 中央の裁断線（プレビュー用） */
      .page > .calendar-container:first-child {
        border-right: 1px dashed #eee;
      }

      /* ヘッダーの余白をさらに圧縮 */
      .header {
        display: flex;
        justify-content: center;
        align-items: baseline;
        border-bottom: 1px solid var(--border-solid);
        padding-bottom: 1px;
        margin-bottom: 1px; /* 2pxから縮小 */
        position: relative;
      }

      .month-large {
        font-size: 38pt; /* 少しだけサイズアップ */
        font-weight: bold;
        color: var(--orange-main);
        line-height: 1;
        text-align: center;
      }

      .year-small {
        font-size: 14pt;
        color: var(--orange-main);
        position: absolute; /* 右端に固定 */
        right: 0;
        bottom: 2px; /* ヘッダー下線に合わせる */
      }

      /* カレンダー本体（2列） */
      .calendar-body {
        flex-grow: 1;
        display: flex;
        border-bottom: 1px solid var(--border-solid);
      }

      .column {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .column-left {
        border-right: 1px dotted var(--border-dotted);
      }

      /* 日付行の祝日名配置を右下に変更 */
      .day-row {
        flex: 1;
        display: flex;
        align-items: center;
        border-bottom: 1px dotted var(--border-dotted);
        padding: 0;
        box-sizing: border-box;
        min-height: 0;
        position: relative; /* 祝日名の配置基準 */
      }

      .day-row:last-child {
        border-bottom: none;
      }

      /* 日付数字を大きく、曜日を小さく調整 */
      .day-num {
        color: var(--orange-main);
        font-weight: 600; /* より太く */
        width: 1.6em; /* 幅を少しタイトに */
        text-align: right;
        margin-right: 6px;
        font-size: 16pt; /* 13ptから拡大 */
      }

      /* 祝日名が右下にあるため、曜日の横の余白は不要 */
      .day-week {
        color: var(--gray-text);
        width: 1em;
        font-size: 8pt;
        text-align: center;
        padding-top: 0.5em;
      }

      .holiday-name {
        position: absolute;
        right: 4px; /* 右端から少し離す */
        bottom: 2px; /* 下端から少し離す */
        font-size: 7pt;
        color: var(--sun-red);
        line-height: 1;
        max-width: 70%; /* 左側の数字に重なりすぎないよう制限 */
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis; /* 長い祝日名は省略 */
        pointer-events: none; /* クリック等の邪魔をしない */
        opacity: 0.8; /* 少し透過させて控えめに */
      }
      /* 色設定 */
      .bg-holiday {
        background-color: var(--bg-holiday);
      }
      .text-sat {
        color: var(--sat-blue) !important;
      }
      .text-sun {
        color: var(--sun-red) !important;
      }

      /* フッターの余白を圧縮 */
      .footer {
        margin-top: 2px;
        padding-top: 1px;
        font-size: 8pt;
        color: var(--gray-light);
        text-align: center;
      }
      /* 読み込み中オーバーレイ */
#loading-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.8);
    z-index: 1000;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    color: var(--orange-main);
}
.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--orange-main);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 10px;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
  </head>
  <body>
    <div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text">祝日データを取得中...</div>
</div>
    <div id="controls">
      <input type="number" id="yearInput" value="2026" /> 年
      <button onclick="generateCalendar()">生成・更新</button>
      <button onclick="window.print()">印刷する</button>
    </div>

    <div id="output"></div>

  <script>
      let holidays = {};

      /**
       * 内閣府の祝日CSVを取得・パース（デバッグログ付き）
       */
     async function fetchHolidays() {
        const overlay = document.getElementById('loading-overlay');
        overlay.style.display = 'flex';
        
        try {
            const targetUrl = 'https://www8.cao.go.jp/chosei/shukujitsu/syukujitsu.csv';
            // 別のプロキシ（y-combinator系のcors-proxy、または shcors）を試行
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;
            
            const response = await fetch(proxyUrl);
            if (!response.ok) throw new Error('CORSプロキシエラー');

            const arrayBuffer = await response.arrayBuffer();
            const decoder = new TextDecoder('shift-jis');
            const text = decoder.decode(arrayBuffer);
            
            const lines = text.split('\n');
            holidays = {};
            for (let i = 1; i < lines.length; i++) {
                const parts = lines[i].split(',');
                if (parts.length >= 2) {
                    const d = new Date(parts[0].trim());
                    if (!isNaN(d.getTime())) {
                        const key = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
                        holidays[key] = parts[1].replace(/\r/g, '').trim();
                    }
                }
            }
            console.log("祝日データ読込完了");
        } catch (e) {
            console.error("取得失敗:", e);
            document.getElementById('loading-text').innerText = "祝日データの取得に失敗しました。";
            setTimeout(() => { overlay.style.display = 'none'; }, 2000);
            return false;
        }
        overlay.style.display = 'none';
        return true;
    }

    async function generateCalendar() {
        const yearInput = document.getElementById("yearInput");
        const btn = document.querySelector("button[onclick^='generateCalendar']");
        const year = parseInt(yearInput.value);
        
        btn.disabled = true;
        btn.innerText = "取得中...";

        if (Object.keys(holidays).length === 0) {
            const success = await fetchHolidays();
            if (!success) {
                btn.disabled = false;
                btn.innerText = "生成・更新";
                return;
            }
        }

        const output = document.getElementById("output");
        output.innerHTML = "";

        for (let m = 1; m <= 12; m += 2) {
            const page = document.createElement("div");
            page.className = "page";
            page.innerHTML = createMonthHtml(year, m) + createMonthHtml(year, m + 1);
            output.appendChild(page);
        }
        
        btn.disabled = false;
        btn.innerText = "生成・更新";
    }

      /**
       * 月データ生成（照合ログ付き）
       */
      function getMonthData(year, month) {
        const lastDay = new Date(year, month, 0).getDate();
        const days = [];
        const weekDays = ["日", "月", "火", "水", "木", "金", "土"];

        for (let d = 1; d <= lastDay; d++) {
          const dateObj = new Date(year, month - 1, d);
          const dateKey = `${year}/${month}/${d}`;
          const dayIdx = dateObj.getDay();
          
          // 祝日判定
          const holidayName = holidays[dateKey];
          const isHoliday = !!holidayName;

          // 1月1日だけ特別にログを出して照合状況を確認
          if (month === 1 && d === 1) {
            console.log(`照合テスト [${dateKey}]: ${isHoliday ? "ヒット！ -> " + holidayName : "一致なし"}`);
          }

          days.push({
            day: d,
            week: weekDays[dayIdx],
            dayIdx: dayIdx,
            holiday: holidayName || "",
            isHoliday: isHoliday,
          });
        }
        return days;
      }

      function createMonthHtml(year, month) {
        const days = getMonthData(year, month);
        let leftColHtml = "";
        let rightColHtml = "";

        for (let i = 0; i < 16; i++) {
          leftColHtml += createDayRowHtml(days[i]);
        }
        for (let i = 16; i < 32; i++) {
          rightColHtml += createDayRowHtml(days[i]);
        }

        return `
            <div class="calendar-container">
                <div class="header">
                    <div class="month-large">${month}</div>
                    <div class="year-small">${year}</div>
                </div>
                <div class="calendar-body">
                    <div class="column column-left">${leftColHtml}</div>
                    <div class="column column-right">${rightColHtml}</div>
                </div>
                <div class="footer">${year} / ${month}</div>
            </div>
        `;
      }

      function createDayRowHtml(dayData) {
        if (!dayData) return '<div class="day-row"></div>';
        let weekClass = "";
        if (dayData.dayIdx === 0 || dayData.isHoliday) weekClass = "text-sun";
        else if (dayData.dayIdx === 6) weekClass = "text-sat";
        const rowClass = (dayData.dayIdx === 0 || dayData.isHoliday || dayData.dayIdx === 6) ? "bg-holiday" : "";

        return `
            <div class="day-row ${rowClass}">
                <div class="day-num">${dayData.day}</div>
                <div class="day-week ${weekClass}">${dayData.week}</div>
                <div class="holiday-name">${dayData.holiday}</div>
            </div>
        `;
      }

      window.onload = generateCalendar;
    </script>
  </body>
</html>
